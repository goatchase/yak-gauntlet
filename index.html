<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>THE YAK GAUNTLET</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<style>
body {
  font-family: 'Roboto', sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f4f1e1; /* matches anus100k */
  color: #000;
  font-size: 12pt;
}

/* Windows 95/97 window style */
.window {
  border: 2px solid #000;
  background: #c0c0c0;
  box-shadow: 2px 2px #fff inset, -2px -2px #808080 inset;
  position: absolute;
}

.titlebar {
  background: #000080;
  color: #fff;
  font-weight: bold;
  padding: 2px 5px;
  cursor: move;
  user-select: none;
}

.window-content {
  padding: 5px;
}

button {
  border: 2px solid #000;
  background: #c0c0c0;
  box-shadow: 2px 2px #fff inset, -2px -2px #808080 inset;
  padding: 2px 8px;
  cursor: pointer;
  font-weight: bold;
  margin: 2px 0;
}
button:hover {
  background: #808080;
}

input, select {
  font-size: 12pt;
  padding: 2px;
  border: 2px inset #fff;
  background: #fff;
}

/* Scoreboard Window */
#scoreboardWindow {
  top: 20px;
  left: 20px;
  width: 65%;
  max-width: 900px;
  height: 80vh;
  display: flex;
  flex-direction: column;
}

#scoreboardWrapper {
  overflow-y: auto;
  flex: 1;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  border: 1px solid #000;
  padding: 4px;
  text-align: left;
}

th {
  background: #000080;
  color: #fff;
  position: sticky;
  top: 0;
  z-index: 10;
}

/* New Entry Window */
#entryWindow {
  top: 20px;
  left: 70%;
  width: 250px;
}

/* Leader & Division Leader */
.leader { background-color: #ccffcc; }
.division-leader { background-color: #dceeff; }
.today-entry { background-color: #ffffaa; }

.stopwatch { font-size: 0.9em; margin-left: 4px; }

</style>
</head>
<body>

<!-- Scoreboard Window -->
<div class="window" id="scoreboardWindow">
  <div class="titlebar">Scoreboard</div>
  <div class="window-content">
    <button id="exportButton">Export Data</button>
    <button id="importButton">Import Data</button>
    <div id="scoreboardWrapper">
      <table id="scoreboard">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Name</th>
            <th>Division</th>
            <th>Category</th>
            <th>Time</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- New Entry Window -->
<div class="window" id="entryWindow">
  <div class="titlebar">New Entry</div>
  <div class="window-content">
    <form id="entryForm">
      <div>
        <label>Name:</label><br>
        <input id="name" required />
      </div>
      <div>
        <label>Division:</label><br>
        <select id="division" required><option disabled selected>Select Division</option></select>
      </div>
      <div>
        <label>Category:</label><br>
        <select id="category" required><option disabled selected>Select Category</option></select>
      </div>
      <div>
        <label>Time (mm ss.ss):</label><br>
        <input id="time" required />
      </div>
      <div>
        <label>Date:</label><br>
        <input id="date" type="date" required />
      </div>
      <div style="margin-top:5px;">
        <button type="submit">Submit</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('date').valueAsDate = new Date();

  const firebaseConfig = {
    apiKey: "AIzaSyCLIgqUBUH-9OLNbPihVrNmy7UaEKzDKZ0",
    authDomain: "goatchase-e9502.firebaseapp.com",
    projectId: "goatchase-e9502",
    storageBucket: "goatchase-e9502.appspot.com",
    messagingSenderId: "16998517478",
    appId: "1:16998517478:web:6386aff8c1d1da2accc927",
    measurementId: "G-YWLJGQG0XD"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const entriesCollection = db.collection("entries");

  const form = document.getElementById('entryForm');
  const scoreboardBody = document.querySelector('#scoreboard tbody');
  const divisionSelect = document.getElementById('division');
  const categorySelect = document.getElementById('category');
  const exportBtn = document.getElementById('exportButton');
  const importBtn = document.getElementById('importButton');

  let entries = [];

  function parseTimeToSeconds(timeStr) {
    const [min, sec] = timeStr.trim().split(" ").map(parseFloat);
    return min*60 + sec;
  }

  function formatTime(seconds) {
    const min = Math.floor(seconds/60);
    const sec = (seconds%60).toFixed(2).padStart(5,'0');
    return `${String(min).padStart(2,'0')} ${sec}`;
  }

  function formatDate(input) {
    const d = new Date(input);
    return `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}/${d.getFullYear()}`;
  }

  async function fetchEntries() {
    const snapshot = await entriesCollection.get();
    entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderScoreboard();
    updateSelectOptions();
  }

  function updateSelectOptions() {
    const divisions = [...new Set(entries.map(e=>e.division))].sort();
    const categories = [...new Set(entries.map(e=>e.category))].sort();
    divisionSelect.innerHTML = '<option disabled selected>Select Division</option>' + divisions.map(d=>`<option>${d}</option>`).join('');
    categorySelect.innerHTML = '<option disabled selected>Select Category</option>' + categories.map(c=>`<option>${c}</option>`).join('');
  }

  function renderScoreboard() {
    scoreboardBody.innerHTML = '';
    entries.forEach((entry,index)=>{
      entry.totalSeconds = parseTimeToSeconds(entry.time);
    });

    let bestOverall = null;
    const bestByDivision = {};
    entries.forEach(entry=>{
      if(!bestOverall||entry.totalSeconds<bestOverall.totalSeconds) bestOverall=entry;
      if(!bestByDivision[entry.division]||entry.totalSeconds<bestByDivision[entry.division].totalSeconds) bestByDivision[entry.division]=entry;
    });

    entries.sort((a,b)=>a.totalSeconds-b.totalSeconds);

    const todayStr = new Date().toISOString().split('T')[0];

    entries.forEach((entry,index)=>{
      const row = document.createElement('tr');
      const entryDateOnly = new Date(entry.date).toISOString().split('T')[0];
      const isToday = entryDateOnly===todayStr;
      const isLeader = entry===bestOverall;
      const isDivisionLeader = bestByDivision[entry.division]===entry;

      if(isLeader) row.classList.add('leader');
      else if(isDivisionLeader) row.classList.add('division-leader');
      if(isToday) row.classList.add('today-entry');

      const daysSince = Math.floor((new Date()-new Date(entry.date))/(1000*60*60*24));
      let iconHTML='';
      if(isLeader) iconHTML=`<span class="stopwatch">ü•á${daysSince} days</span>`;
      else if(isDivisionLeader) iconHTML=`<span class="stopwatch">‚è±Ô∏è${daysSince} days</span>`;

      row.innerHTML=`<td>${index+1}</td><td>${entry.name}</td><td>${entry.division}</td><td>${entry.category}</td><td>${formatTime(entry.totalSeconds)} ${iconHTML}</td><td>${formatDate(entry.date)}</td>`;
      scoreboardBody.appendChild(row);
    });
  }

  form.addEventListener('submit', async e=>{
    e.preventDefault();
    const name=document.getElementById('name').value.trim();
    const division=divisionSelect.value;
    const category=categorySelect.value;
    const time=document.getElementById('time').value.trim();
    const dateInput=document.getElementById('date').value;
    if(!name||!division||!category||!time||!dateInput){alert("Fill all fields");return;}
    const [y,m,d]=dateInput.split('-').map(Number);
    const now=new Date();
    const combined=new Date(y,m-1,d,now.getHours(),now.getMinutes(),now.getSeconds(),now.getMilliseconds());
    const dateTimeStr=combined.toISOString();
    await entriesCollection.add({name,division,category,time,date:dateTimeStr});
    form.reset();
    fetchEntries();
  });

  // Export / Import
  exportBtn.addEventListener('click', ()=>{
    const dataStr = JSON.stringify(entries, null, 2);
    const blob = new Blob([dataStr], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url;a.download="entries.json";a.click();
    URL.revokeObjectURL(url);
  });

  importBtn.addEventListener('click', ()=>{
    const input = document.createElement('input');
    input.type='file';input.accept='application/json';
    input.onchange=async e=>{
      const file = e.target.files[0];
      const text = await file.text();
      const json = JSON.parse(text);
      for(const entry of json){
        await entriesCollection.add(entry);
      }
      fetchEntries();
    };
    input.click();
  });

  fetchEntries();
});
</script>

</body>
</html>
