<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>YAK GAUNTLET Scoreboard</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f4f4;
    margin: 0;
    padding: 20px;
  }
  h1 {
    text-align: center;
  }
  .form-container,
  .filter-container,
  .table-container {
    background: white;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  label {
    display: block;
    margin-top: 10px;
  }
  input, select, button {
    padding: 8px;
    margin-top: 5px;
    width: 100%;
    box-sizing: border-box;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  th, td {
    padding: 10px;
    border-bottom: 1px solid #ccc;
    text-align: left;
  }
  tr.highlight-overall {
    background-color: #c4f7c4 !important;
  }
  tr.highlight-today {
    background-color: #fff7c4 !important;
  }
  .stopwatch {
    font-size: 18px;
    margin-left: 6px;
  }
  .gold { color: gold; }
  .blue { color: dodgerblue; }
</style>
</head>

<body>

<h1>YAK GAUNTLET Scoreboard</h1>

<!-- ---------------- FORM ---------------- -->
<div class="form-container">
  <h2>Add Entry</h2>
  
  <label for="name">Name</label>
  <input id="name" required />

  <label for="division">Division</label>
  <select id="division" required>
    <option value="" disabled selected>Select Division</option>
  </select>

  <label for="category">Category</label>
  <input id="category" placeholder="Category" required />

  <label for="time">Time (seconds)</label>
  <input id="time" type="number" step="0.01" required />

  <label for="date">Date</label>
  <input id="date" type="date" required />

  <button id="addEntryBtn">Add Entry</button>
</div>

<!-- ---------------- FILTERS ---------------- -->
<div class="filter-container">
  <h2>Filters</h2>

  <label for="searchInput">Search Name</label>
  <input id="searchInput" type="search" placeholder="Search..." />

  <label for="divisionFilter">Division</label>
  <select id="divisionFilter">
    <option value="All">All</option>
  </select>

  <label for="categoryFilter">Category</label>
  <input id="categoryFilter" type="search" placeholder="All" />
</div>

<!-- ---------------- TABLE ---------------- -->
<div class="table-container">
  <table id="scoreTable">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Name</th>
        <th>Division</th>
        <th>Category</th>
        <th>Time</th>
        <th>Date</th>
        <th>Days</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
/* ----------------------------------------------------
   FIREBASE INIT
---------------------------------------------------- */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ----------------------------------------------------
   DOM ELEMENTS
---------------------------------------------------- */
const nameInput = document.getElementById("name");
const divisionSelect = document.getElementById("division");
const categoryInput = document.getElementById("category");
const timeInput = document.getElementById("time");
const dateInput = document.getElementById("date");

const addEntryBtn = document.getElementById("addEntryBtn");

const searchInput = document.getElementById("searchInput");
const divisionFilter = document.getElementById("divisionFilter");
const categoryFilter = document.getElementById("categoryFilter");

const tableBody = document.querySelector("#scoreTable tbody");

let entries = [];

/* ----------------------------------------------------
   LOAD DIVISIONS FROM DATABASE
---------------------------------------------------- */
function loadDivisions() {
  db.collection("divisions")
    .orderBy("name")
    .get()
    .then(snapshot => {
      divisionSelect.innerHTML = `<option value="" disabled selected>Select Division</option>`;
      divisionFilter.innerHTML = `<option value="All">All</option>`;

      snapshot.forEach(doc => {
        const division = doc.data().name;
        divisionSelect.innerHTML += `<option value="${division}">${division}</option>`;
        divisionFilter.innerHTML += `<option value="${division}">${division}</option>`;
      });
    });
}

/* ----------------------------------------------------
   FETCH ENTRIES
---------------------------------------------------- */
function loadEntries() {
  db.collection("entries")
    .orderBy("time")
    .get()
    .then(snapshot => {
      entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderTable();
    });
}

/* ----------------------------------------------------
   ADD ENTRY
---------------------------------------------------- */
addEntryBtn.addEventListener("click", () => {
  const name = nameInput.value.trim();
  const division = divisionSelect.value;
  const category = categoryInput.value.trim();
  const time = parseFloat(timeInput.value);
  const date = dateInput.value;

  if (!name || !division || !category || !time || !date) return;

  db.collection("entries").add({ name, division, category, time, date })
    .then(() => {
      nameInput.value = "";
      categoryInput.value = "";
      timeInput.value = "";
      dateInput.value = "";
      divisionSelect.value = "";
      loadEntries();
    });
});

/* ----------------------------------------------------
   RENDER TABLE
---------------------------------------------------- */
function renderTable() {
  const today = new Date().toISOString().split("T")[0];

  let filtered = entries.filter(entry =>
    entry.name.toUpperCase().includes(searchInput.value.toUpperCase()) &&
    (divisionFilter.value === "All" || entry.division === divisionFilter.value) &&
    (categoryFilter.value.trim() === "" ||
     entry.category.toUpperCase().includes(categoryFilter.value.toUpperCase()))
  );

  // Rank based on time
  filtered.sort((a, b) => a.time - b.time);

  // Determine overall leader
  const bestOverall = filtered.length > 0 ? filtered[0].time : null;

  tableBody.innerHTML = "";

  filtered.forEach((e, index) => {
    const dateObj = new Date(e.date);
    const daysSince = Math.floor((Date.now() - dateObj.getTime()) / (1000 * 60 * 60 * 24));

    const isToday = e.date === today;
    const isOverallLeader = e.time === bestOverall;

    const row = document.createElement("tr");

    if (isOverallLeader) row.classList.add("highlight-overall");
    if (isToday) row.classList.add("highlight-today");

    row.innerHTML = `
      <td>${index + 1} ${isOverallLeader ? `<span class="stopwatch gold">‚è±</span>` : ""}</td>
      <td>${e.name}</td>
      <td>${e.division}</td>
      <td>${e.category}</td>
      <td>${e.time.toFixed(2)}</td>
      <td>${e.date}</td>
      <td>${daysSince}</td>
    `;

    tableBody.appendChild(row);
  });
}

/* ----------------------------------------------------
   FILTER LISTENERS
---------------------------------------------------- */
searchInput.addEventListener("input", renderTable);
divisionFilter.addEventListener("change", renderTable);
categoryFilter.addEventListener("input", renderTable);

/* ----------------------------------------------------
   INITIAL LOAD
---------------------------------------------------- */
loadDivisions();
loadEntries();
</script>

</body>
</html>
