<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>THE YAK GAUNTLET</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; }
    h1 { text-align: center; }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: center; }
    tr:hover { background: #f1f1f1; cursor: pointer; }

    .leader { background: #d8f8d8 !important; }
    .today { background: #fff8d8 !important; }
    .stopwatch { font-size: 14px; margin-left: 5px; }

    /* Modal */
    #divisionModal {
      display: none; position: fixed; z-index: 999;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
    }
    #divisionModalContent {
      background: #fff; margin: 5% auto; padding: 20px;
      border-radius: 10px; width: 90%; max-width: 900px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    #closeModal {
      float: right; cursor: pointer; font-size: 20px; font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>THE YAK GAUNTLET</h1>

  <table id="scoreboard">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Name</th>
        <th>Division</th>
        <th>Category</th>
        <th>Time (s)</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody id="entriesTable"></tbody>
  </table>

  <!-- Modal -->
  <div id="divisionModal">
    <div id="divisionModalContent">
      <span id="closeModal">&times;</span>
      <h2>Division Scatter Plot</h2>
      <canvas id="divisionChart" width="800" height="400"></canvas>
    </div>
  </div>

  <script>
    // ==== Firebase Config (replace with your credentials) ====
    var firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const entriesTable = document.getElementById("entriesTable");
    const modal = document.getElementById("divisionModal");
    const closeModal = document.getElementById("closeModal");
    const ctx = document.getElementById("divisionChart").getContext("2d");
    let divisionChart;

    // Add jitter to scatter y-axis
    function jitter() {
      return (Math.random() - 0.5) * 0.4;
    }

    // Color palette for divisions
    const divisionColors = [
      "#1f77b4","#ff7f0e","#2ca02c","#d62728",
      "#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"
    ];
    function getDivisionColor(division) {
      let idx = Math.abs(division.split("").reduce((a,c)=>a+c.charCodeAt(0),0)) % divisionColors.length;
      return divisionColors[idx];
    }

    // Render table
    db.collection("entries").orderBy("time").onSnapshot(snapshot => {
      entriesTable.innerHTML = "";
      let rank = 1;
      snapshot.forEach(doc => {
        const e = doc.data();
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${rank}</td>
          <td class="clickable-name" data-id="${doc.id}">${e.name}</td>
          <td>${e.division}</td>
          <td>${e.category}</td>
          <td>${e.time.toFixed(2)}</td>
          <td>${new Date(e.date).toLocaleDateString()}</td>
        `;
        entriesTable.appendChild(row);
        rank++;
      });

      // Add click listeners to names
      document.querySelectorAll(".clickable-name").forEach(cell => {
        cell.addEventListener("click", () => {
          const id = cell.dataset.id;
          openDivisionModal(id);
        });
      });
    });

    // Open modal with chart
    function openDivisionModal(clickedId) {
      db.collection("entries").get().then(snapshot => {
        let datasets = [];
        let highlighted = null;

        snapshot.forEach(doc => {
          const e = doc.data();
          const point = {
            x: e.time,
            y: jitter(),
            name: e.name,
            division: e.division,
            date: new Date(e.date).toLocaleDateString()
          };

          if (doc.id === clickedId) {
            highlighted = point;
          } else {
            let color = getDivisionColor(e.division);
            datasets.push({
              label: e.division,
              data: [point],
              pointBackgroundColor: color,
              pointRadius: 5
            });
          }
        });

        // Highlight clicked runner
        if (highlighted) {
          datasets.push({
            label: highlighted.name + " (highlighted)",
            data: [highlighted],
            pointBackgroundColor: "gold",
            pointBorderColor: "black",
            pointBorderWidth: 2,
            pointRadius: 10
          });
        }

        // Destroy old chart if exists
        if (divisionChart) divisionChart.destroy();

        // Build chart
        divisionChart = new Chart(ctx, {
          type: "scatter",
          data: { datasets },
          options: {
            responsive: true,
            plugins: {
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    let p = ctx.raw;
                    return `${p.name} (${p.division}) - ${p.x}s on ${p.date}`;
                  }
                }
              },
              legend: { display: true }
            },
            scales: {
              x: {
                title: { display: true, text: "Time (s)" }
              },
              y: {
                display: false // hide jitter axis
              }
            }
          }
        });

        modal.style.display = "block";
      });
    }

    // Close modal
    closeModal.onclick = () => { modal.style.display = "none"; };
    window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; };
  </script>
</body>
</html>
