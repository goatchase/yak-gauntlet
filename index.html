<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>THE YAK GAUNTLET</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
      color: #001f3f;
      text-transform: uppercase;
      font-size: 12pt;
    }
    h1 {
      font-size: 20pt;
      text-align: center;
      color: #001f3f;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .subtitle {
      text-align: center;
      font-style: italic;
      font-size: 10pt;
      margin-bottom: 20px;
      color: #001f3f;
    }
    form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    form input, form select, form button {
      padding: 10px;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
      text-transform: none;
    }
    form button {
      background-color: #990000;
      color: white;
      cursor: pointer;
    }
    form button:hover {
      background-color: #770000;
    }
    #divisionContainer, #categoryContainer {
      display: flex;
      flex-direction: column;
    }
    #divisionOther, #categoryOther {
      margin-top: 5px;
      padding: 8px;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
      text-transform: none;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      font-size: 0.9em;
    }
    .top-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .edit-button, .unfilter-button, .open-stats-button {
      background-color: #007bff;
      color: white;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      font-size: 1em;
    }
    .edit-button:hover, .unfilter-button:hover, .open-stats-button:hover {
      background-color: #0056b3;
    }
    select, input[type="search"] {
      padding: 5px;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
      text-transform: none;
    }
    table {
      width: 100%;
      margin-top: 10px;
      border-collapse: collapse;
      table-layout: auto;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      text-align: left;
      text-transform: uppercase;
    }
    th {
      font-weight: bold;
      background-color: #f4f4f4;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:hover {
      background-color: #f1f1f1;
    }
    .leader {
      background-color: #ccffcc !important;
    }
    .division-leader {
      background-color: #dceeff !important;
    }
    .today-entry {
      background-color: #fffacd !important;
    }
    .stopwatch {
      font-size: 1em;
      margin-left: 6px;
    }
    .gold { color: gold; }
    .blue { color: #3399ff; }
    @media (max-width: 600px) {
      .top-bar {
        flex-direction: column;
        align-items: stretch;
      }
      .filters,
      .top-controls {
        flex-direction: column;
        width: 100%;
        gap: 5px;
      }
      .filter-group {
        width: 100%;
      }
      .top-controls input,
      .top-controls button {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <h1>THE YAK GAUNTLET</h1>
  <div class="subtitle">CORNHOLE • SOCCER • WIFFLE • FOOTBALL • BASKETBALL • SP@#$%&</div>

  <form id="entryForm">
    <input id="name" placeholder="Name" required />

    <div id="divisionContainer">
      <select id="division" required>
        <option value="" disabled selected>Select Division</option>
        <option>Mens</option>
        <option>Womens</option>
        <option>Coed</option>
        <option>Other</option>
      </select>
    </div>

    <div id="categoryContainer">
      <select id="category" required>
        <option value="" disabled selected>Select Category</option>
        <option>Novice</option>
        <option>Intermediate</option>
        <option>Advanced</option>
        <option>Other</option>
      </select>
    </div>

    <input id="time" placeholder="Time (mm ss.ss)" required />
    <input id="date" type="date" required />
    <button type="submit">Submit</button>
  </form>

  <div class="top-bar">
    <div class="filters">
      <div class="filter-group">
        <label for="divisionFilter">Division</label>
        <select id="divisionFilter"><option value="All">All</option></select>
      </div>
      <div class="filter-group">
        <label for="categoryFilter">Category</label>
        <select id="categoryFilter"><option value="All">All</option></select>
      </div>
    </div>
    <div class="top-controls">
      <input id="searchInput" type="search" placeholder="Search name" />
      <button id="editButton" class="edit-button">Edit</button>
      <button id="unfilterButton" class="unfilter-button">Unfilter</button>
      <button id="openStatsButton" class="open-stats-button">Stats</button>
    </div>
  </div>

  <table id="scoreboard">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Name</th>
        <th>Division</th>
        <th>Category</th>
        <th>Time</th>
        <th>Date</th>
        <th id="actionHeader" style="display: none;">Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const firebaseConfig = {
      apiKey: "AIzaSyCLIgqUBUH-9OLNbPihVrNmy7UaEKzDKZ0",
      authDomain: "goatchase-e9502.firebaseapp.com",
      projectId: "goatchase-e9502",
      storageBucket: "goatchase-e9502.appspot.com",
      messagingSenderId: "16998517478",
      appId: "1:16998517478:web:6386aff8c1d1da2accc927",
      measurementId: "G-YWLJGQG0XD"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const entriesCollection = db.collection("entries");

    const form = document.getElementById('entryForm');
    const scoreboard = document.getElementById('scoreboard').querySelector('tbody');
    const editButton = document.getElementById('editButton');
    const unfilterButton = document.getElementById('unfilterButton');
    const openStatsButton = document.getElementById('openStatsButton');
    const searchInput = document.getElementById('searchInput');
    const divisionFilter = document.getElementById('divisionFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const actionHeader = document.getElementById('actionHeader');
    const divisionSelect = document.getElementById('division');
    const categorySelect = document.getElementById('category');
    const nameInput = document.getElementById('name');
    const timeInput = document.getElementById('time');
    const dateInput = document.getElementById('date');
    const divisionContainer = document.getElementById('divisionContainer');
    const categoryContainer = document.getElementById('categoryContainer');

    let entries = [];
    let isEditMode = false;
    const editPassword = "benjaminmintz1"; // Change this as needed

    // Utility functions
    function formatDate(input) {
      const d = new Date(input);
      return `${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}/${d.getFullYear()}`;
    }

    function parseTimeToSeconds(timeStr) {
      const parts = timeStr.trim().split(" ");
      if (parts.length !== 2) return NaN;
      const [min, sec] = parts.map(parseFloat);
      return min * 60 + sec;
    }

    function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = (seconds % 60).toFixed(2).padStart(5, '0');
      return `${String(min).padStart(2,'0')} ${sec}`;
    }

    function getDaysSince(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diffTime = now - date;
      return Math.floor(diffTime / (1000 * 60 * 60 * 24));
    }

    // Add or remove text input for "Other" in Division
    function handleDivisionChange() {
      const selected = divisionSelect.value;
      let otherInput = document.getElementById('divisionOther');
      if (selected === "Other") {
        if (!otherInput) {
          otherInput = document.createElement('input');
          otherInput.id = 'divisionOther';
          otherInput.placeholder = 'Enter Division';
          otherInput.required = true;
          divisionContainer.appendChild(otherInput);
        }
      } else {
        if (otherInput) {
          otherInput.remove();
        }
      }
    }

    // Add or remove text input for "Other" in Category
    function handleCategoryChange() {
      const selected = categorySelect.value;
      let otherInput = document.getElementById('categoryOther');
      if (selected === "Other") {
        if (!otherInput) {
          otherInput = document.createElement('input');
          otherInput.id = 'categoryOther';
          otherInput.placeholder = 'Enter Category';
          otherInput.required = true;
          categoryContainer.appendChild(otherInput);
        }
      } else {
        if (otherInput) {
          otherInput.remove();
        }
      }
    }

    divisionSelect.addEventListener('change', handleDivisionChange);
    categorySelect.addEventListener('change', handleCategoryChange);

    // Load entries from Firestore and render scoreboard
    function loadEntries() {
      entriesCollection.orderBy("time").get().then(snapshot => {
        entries = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          data.id = doc.id;
          entries.push(data);
        });
        updateFilterOptions();
        renderScoreboard();
      });
    }

    function updateFilterOptions() {
      const divisionsSet = new Set(entries.map(e => e.division));
      const categoriesSet = new Set(entries.map(e => e.category));
      
      // Update division filter
      const currentDivision = divisionFilter.value;
      divisionFilter.innerHTML = '<option value="All">All</option>';
      [...divisionsSet].sort().forEach(div => {
        const opt = document.createElement('option');
        opt.value = div;
        opt.textContent = div;
        divisionFilter.appendChild(opt);
      });
      divisionFilter.value = currentDivision || "All";

      // Update category filter
      const currentCategory = categoryFilter.value;
      categoryFilter.innerHTML = '<option value="All">All</option>';
      [...categoriesSet].sort().forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        categoryFilter.appendChild(opt);
      });
      categoryFilter.value = currentCategory || "All";
    }

    // Filter, sort, and render the scoreboard table
    function renderScoreboard() {
      const searchTerm = searchInput.value.toLowerCase();
      const divisionSelected = divisionFilter.value;
      const categorySelected = categoryFilter.value;
      const todayStr = new Date().toISOString().slice(0,10);

      // Filter entries by search, division, and category
      let filteredEntries = entries.filter(e => {
        const matchName = e.name.toLowerCase().includes(searchTerm);
        const matchDivision = (divisionSelected === "All") || (e.division === divisionSelected);
        const matchCategory = (categorySelected === "All") || (e.category === categorySelected);
        return matchName && matchDivision && matchCategory;
      });

      // Sort by time ascending
      filteredEntries.sort((a,b) => parseTimeToSeconds(a.time) - parseTimeToSeconds(b.time));

      // Render rows
      scoreboard.innerHTML = "";
      filteredEntries.forEach((entry, idx) => {
        const tr = document.createElement('tr');

        // Rank
        const rankTd = document.createElement('td');
        rankTd.textContent = idx + 1;
        tr.appendChild(rankTd);

        // Name
        const nameTd = document.createElement('td');
        nameTd.textContent = entry.name;
        tr.appendChild(nameTd);

        // Division
        const divisionTd = document.createElement('td');
        divisionTd.textContent = entry.division;
        tr.appendChild(divisionTd);

        // Category
        const categoryTd = document.createElement('td');
        categoryTd.textContent = entry.category;
        tr.appendChild(categoryTd);

        // Time
        const timeTd = document.createElement('td');
        timeTd.textContent = entry.time;
        tr.appendChild(timeTd);

        // Date
        const dateTd = document.createElement('td');
        dateTd.textContent = formatDate(entry.date);
        tr.appendChild(dateTd);

        scoreboard.appendChild(tr);
      });
    }

    // Handle form submission
    form.addEventListener('submit', e => {
      e.preventDefault();

      let divisionValue = divisionSelect.value;
      let categoryValue = categorySelect.value;

      // If "Other" selected, get the input value instead
      if (divisionValue === "Other") {
        const otherInput = document.getElementById('divisionOther');
        if (!otherInput || !otherInput.value.trim()) {
          alert('Please enter a Division');
          return;
        }
        divisionValue = otherInput.value.trim();
      }

      if (categoryValue === "Other") {
        const otherInput = document.getElementById('categoryOther');
        if (!otherInput || !otherInput.value.trim()) {
          alert('Please enter a Category');
          return;
        }
        categoryValue = otherInput.value.trim();
      }

      const nameValue = nameInput.value.trim();
      const timeValue = timeInput.value.trim();
      const dateValue = dateInput.value;

      if (!nameValue || !timeValue || !dateValue || !divisionValue || !categoryValue) {
        alert('Please fill in all fields');
        return;
      }

      if (isNaN(parseTimeToSeconds(timeValue))) {
        alert('Invalid time format. Use mm ss.ss');
        return;
      }

      // Save to Firestore
      entriesCollection.add({
        name: nameValue,
        division: divisionValue,
        category: categoryValue,
        time: timeValue,
        date: dateValue
      }).then(() => {
        form.reset();
        // Remove "Other" inputs if present
        const divisionOther = document.getElementById('divisionOther');
        if (divisionOther) divisionOther.remove();
        const categoryOther = document.getElementById('categoryOther');
        if (categoryOther) categoryOther.remove();
        loadEntries();
      }).catch(err => {
        alert('Error saving entry: ' + err.message);
      });
    });

    // Filters and search events
    divisionFilter.addEventListener('change', renderScoreboard);
    categoryFilter.addEventListener('change', renderScoreboard);
    searchInput.addEventListener('input', renderScoreboard);

    // Initial load
    loadEntries();
  });
</script>

</body>
</html>
