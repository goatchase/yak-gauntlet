<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>THE YAK GAUNTLET</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px 80px;
      background-color: #f4f4f4;
      color: #001f3f;
      text-transform: uppercase;
      font-size: 12pt;
    }

    h1 {
      font-size: 28pt;
      text-align: center;
      color: #001f3f;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .subtitle {
      text-align: center;
      font-size: 10pt;
      margin-bottom: 20px;
      color: #001f3f;
    }

    .controls-wrapper, .controls-row, .form-row, .second-row, .left-group, .right-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      width: 100%;
    }

    form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }

    form input, form select, form button {
      padding: 5px;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    form button {
      background-color: #990000;
      color: white;
      cursor: pointer;
    }

    .edit-button, .unfilter-button, .open-stats-button {
      background-color: #007bff;
      color: white;
      padding: 5px 10px;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      font-size: 1em;
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
    }

    th, td {
      padding: 5px;
      border-bottom: 1px solid #ddd;
      text-align: left;
      user-select: none;
    }

    tr:hover { background-color: #f1f1f1; }
    .leader { background-color: #ccffcc !important; }
    .division-leader { background-color: #dceeff !important; }
    .today-entry { background-color: #fffacd !important; }

    .clickable-name {
      color: #007bff;
      cursor: pointer;
    }

    .clickable-name:hover {
      text-decoration: underline;
    }

    #chartSection {
      margin-top: 40px;
      display: none;
    }

    @media (max-width: 768px) {
      body { padding: 20px; }
    }
  </style>
</head>
<body>

  <h1>THE YAK GAUNTLET</h1>
  <div class="subtitle">
    <img src="YG2.png" class="subtitle-img" />
  </div>

  <div class="controls-wrapper">
    <div class="form-row">
      <form id="entryForm">
        <input id="name" placeholder="Name" required />
        <select id="division" required><option value="" disabled selected>Select Division</option></select>
        <select id="category" required><option value="" disabled selected>Select Category</option></select>
        <input id="time" placeholder="Time (mm ss.ss)" required />
        <input id="date" type="date" required />
        <button type="submit">Submit</button>
      </form>
    </div>

    <div class="second-row">
      <div class="left-group">
        <select id="divisionFilter"><option value="All">All</option></select>
        <select id="categoryFilter"><option value="All">All</option></select>
        <button id="unfilterButton" class="unfilter-button">Unfilter</button>
      </div>
      <div class="right-group">
        <input id="searchInput" type="search" placeholder="Search name" />
        <button id="editButton" class="edit-button">Edit</button>
        <button id="randomButton" class="open-stats-button">Random</button>
        <button id="openStatsButton" class="open-stats-button">Stats</button>
      </div>
    </div>
  </div>

  <div class="table-wrapper">
    <table id="scoreboard">
      <thead>
        <tr>
          <th class="sortable" data-column="rank">Rank</th>
          <th class="sortable" data-column="name">Name</th>
          <th class="sortable" data-column="division">Division</th>
          <th class="sortable" data-column="category">Category</th>
          <th class="sortable" data-column="time">Time</th>
          <th class="sortable" data-column="date">Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ðŸ“Š Chart Section -->
  <div id="chartSection">
    <h2 id="chartTitle">Performance Chart</h2>
    <canvas id="nameChart" height="100"></canvas>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCLIgqUBUH-9OLNbPihVrNmy7UaEKzDKZ0",
      authDomain: "goatchase-e9502.firebaseapp.com",
      projectId: "goatchase-e9502",
      storageBucket: "goatchase-e9502.appspot.com",
      messagingSenderId: "16998517478",
      appId: "1:16998517478:web:6386aff8c1d1da2accc927",
      measurementId: "G-YWLJGQG0XD"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const entriesCollection = db.collection("entries");

    const form = document.getElementById('entryForm');
    const scoreboard = document.getElementById('scoreboard').querySelector('tbody');
    const divisionFilter = document.getElementById('divisionFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const divisionSelect = document.getElementById('division');
    const categorySelect = document.getElementById('category');
    const searchInput = document.getElementById('searchInput');
    const chartTitle = document.getElementById('chartTitle');
    const chartSection = document.getElementById('chartSection');
    let entries = [], chart = null;

    function formatDate(input) {
      const d = new Date(input);
      return `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}/${d.getFullYear()}`;
    }

    function parseTimeToSeconds(timeStr) {
      const [min, sec] = timeStr.split(" ").map(parseFloat);
      return min * 60 + sec;
    }

    function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = (seconds % 60).toFixed(2).padStart(5, '0');
      return `${String(min).padStart(2, '0')} ${sec}`;
    }

    function updateFilterOptions() {
      const divisions = [...new Set(entries.map(e => e.division))].sort();
      const categories = [...new Set(entries.map(e => e.category))].sort();

      divisionFilter.innerHTML = '<option value="All">All</option>' + divisions.map(d => `<option>${d}</option>`).join('');
      categoryFilter.innerHTML = '<option value="All">All</option>' + categories.map(c => `<option>${c}</option>`).join('');
      divisionSelect.innerHTML = '<option value="" disabled selected>Select Division</option>' + divisions.map(d => `<option>${d}</option>`).join('');
      categorySelect.innerHTML = '<option value="" disabled selected>Select Category</option>' + categories.map(c => `<option>${c}</option>`).join('');
    }

    async function fetchEntries() {
      const snapshot = await entriesCollection.get();
      entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderScoreboard();
    }

    function renderScoreboard() {
      scoreboard.innerHTML = '';
      entries.forEach(e => e.totalSeconds = parseTimeToSeconds(e.time));

      const filtered = entries.filter(e =>
        (divisionFilter.value === 'All' || e.division === divisionFilter.value) &&
        (categoryFilter.value === 'All' || e.category === categoryFilter.value) &&
        e.name.toLowerCase().includes(searchInput.value.toLowerCase())
      ).sort((a, b) => a.totalSeconds - b.totalSeconds);

      filtered.forEach((entry, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td class="clickable-name" data-name="${entry.name}">${entry.name}</td>
          <td>${entry.division}</td>
          <td>${entry.category}</td>
          <td>${formatTime(entry.totalSeconds)}</td>
          <td>${formatDate(entry.date)}</td>
        `;
        scoreboard.appendChild(row);

        row.querySelector('.clickable-name').addEventListener('click', () => {
          showChartForName(entry.name);
        });
      });

      updateFilterOptions();
    }

    function showChartForName(name) {
      const data = entries.filter(e => e.name.toLowerCase() === name.toLowerCase())
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      const labels = data.map(e => formatDate(e.date));
      const values = data.map(e => parseTimeToSeconds(e.time));

      if (chart) chart.destroy();
      const ctx = document.getElementById('nameChart').getContext('2d');

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: `${name}'s Times`,
            data: values,
            borderColor: '#001f3f',
            backgroundColor: 'rgba(0, 31, 63, 0.2)',
            tension: 0.3,
            pointRadius: 5,
            pointHoverRadius: 7
          }]
        },
        options: {
          scales: {
            y: { title: { display: true, text: 'Time (seconds)' } },
            x: { title: { display: true, text: 'Date' } }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });

      chartTitle.textContent = `${name}'s Performance Over Time`;
      chartSection.style.display = 'block';
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const entry = {
        name: document.getElementById('name').value.trim(),
        division: divisionSelect.value,
        category: categorySelect.value,
        time: document.getElementById('time').value.trim(),
        date: new Date(document.getElementById('date').value).toISOString()
      };
      await entriesCollection.add(entry);
      form.reset();
      fetchEntries();
    });

    divisionFilter.addEventListener('change', renderScoreboard);
    categoryFilter.addEventListener('change', renderScoreboard);
    searchInput.addEventListener('input', renderScoreboard);

    document.getElementById('unfilterButton').addEventListener('click', () => {
      divisionFilter.value = 'All';
      categoryFilter.value = 'All';
      searchInput.value = '';
      renderScoreboard();
    });

    document.getElementById('openStatsButton').addEventListener('click', () => {
      window.open('stats.html', '_blank');
    });

    document.getElementById('randomButton').addEventListener('click', () => {
      const r = entries[Math.floor(Math.random() * entries.length)];
      alert(`${r.name} | ${r.division} | ${r.category} | ${r.time}`);
    });

    fetchEntries();
  </script>
</body>
</html>
