<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YAK GAUNTLET</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; color: #333; }
    h1 { font-size: 2em; margin-bottom: 0.2em; }
    form { margin-bottom: 20px; }
    select, input[type="text"], input[type="number"], input[type="date"] {
      padding: 6px; margin: 6px 4px; font-size: 1em;
    }
    input[type="submit"] {
      padding: 8px 12px; font-size: 1em; background-color: #4CAF50;
      color: white; border: none; cursor: pointer;
    }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
    }
    th, td {
      padding: 10px; border-bottom: 1px solid #ddd; text-align: left;
    }
    tr:hover { background-color: #f1f1f1; }
    .highlight { background-color: #e6ffe6; }
    .today { background-color: #fffdd0; }
    .gold { color: goldenrod; }
    .blue { color: steelblue; }
  </style>
</head>
<body>
  <h1>YAK GAUNTLET</h1>
  <form id="entryForm">
    <input type="text" id="name" placeholder="Name" required />
    
    <select id="division" required>
      <option value="" disabled selected>Select Division</option>
    </select>
    <input type="text" id="divisionOther" placeholder="Enter Division" style="display:none;" />

    <select id="category" required>
      <option value="" disabled selected>Select Category</option>
    </select>
    <input type="text" id="categoryOther" placeholder="Enter Category" style="display:none;" />

    <input type="number" id="time" placeholder="Time (s)" required />
    <input type="date" id="date" required />
    <input type="submit" value="Submit" />
  </form>

  <table id="scoreboard">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Name</th>
        <th>Division</th>
        <th>Category</th>
        <th>Time (s)</th>
        <th>Date</th>
        <th>üèÜ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, orderBy
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const entriesRef = collection(db, "entries");

    const form = document.getElementById("entryForm");
    const scoreboard = document.querySelector("#scoreboard tbody");
    const nameInput = document.getElementById("name");
    const divisionSelect = document.getElementById("division");
    const categorySelect = document.getElementById("category");
    const divisionOther = document.getElementById("divisionOther");
    const categoryOther = document.getElementById("categoryOther");
    const timeInput = document.getElementById("time");
    const dateInput = document.getElementById("date");

    // Handle "Other" inputs
    divisionSelect.addEventListener("change", () => {
      divisionOther.style.display = divisionSelect.value === "Other" ? "inline-block" : "none";
    });

    categorySelect.addEventListener("change", () => {
      categoryOther.style.display = categorySelect.value === "Other" ? "inline-block" : "none";
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = nameInput.value.trim();
      const division = divisionSelect.value === "Other" ? divisionOther.value.trim() : divisionSelect.value;
      const category = categorySelect.value === "Other" ? categoryOther.value.trim() : categorySelect.value;
      const time = parseFloat(timeInput.value);
      const dateRaw = dateInput.value;
      const date = new Date(dateRaw + "T00:00:00Z");

      if (!name || !division || !category || !time || !dateRaw) {
        alert("Please fill in all fields.");
        return;
      }

      await addDoc(entriesRef, { name, division, category, time, date });
      form.reset();
      divisionOther.style.display = "none";
      categoryOther.style.display = "none";
      renderScoreboard();
    });

    async function renderScoreboard() {
      const q = query(entriesRef, orderBy("time"));
      const querySnapshot = await getDocs(q);
      const entries = [];
      querySnapshot.forEach((doc) => entries.push({ id: doc.id, ...doc.data() }));

      scoreboard.innerHTML = "";

      const today = new Date().toISOString().split("T")[0];
      const bestTimesByDivision = {};
      let fastestTime = Infinity;
      let fastestEntryId = null;

      entries.forEach((entry) => {
        const div = entry.division;
        if (!(div in bestTimesByDivision) || entry.time < bestTimesByDivision[div].time) {
          bestTimesByDivision[div] = entry;
        }
        if (entry.time < fastestTime) {
          fastestTime = entry.time;
          fastestEntryId = entry.id;
        }
      });

      const divisions = new Set();
      const categories = new Set();

      entries.forEach((entry, index) => {
        const entryDate = new Date(entry.date.seconds * 1000);
        const formattedDate = entryDate.toISOString().split("T")[0];
        const isToday = formattedDate === today;
        const isFastest = entry.id === fastestEntryId;
        const isDivisionLeader = bestTimesByDivision[entry.division]?.id === entry.id;
        const daysSince = Math.floor((new Date() - entryDate) / (1000 * 60 * 60 * 24));

        divisions.add(entry.division);
        categories.add(entry.category);

        const row = document.createElement("tr");
        if (isFastest) row.classList.add("highlight");
        if (isToday) row.classList.add("today");

        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${entry.name}</td>
          <td>${entry.division}</td>
          <td>${entry.category}</td>
          <td>${entry.time.toFixed(2)}</td>
          <td>${formattedDate}</td>
          <td>
            ${isFastest ? `<span class="gold">‚è±Ô∏è ${daysSince}</span>` :
              isDivisionLeader ? `<span class="blue">‚è±Ô∏è ${daysSince}</span>` : ""}
          </td>
        `;
        scoreboard.appendChild(row);
      });

      updateFilterOptions([...divisions], [...categories]);
    }

    function updateFilterOptions(divisions, categories) {
      divisionSelect.innerHTML = '<option value="" disabled selected>Select Division</option>' +
        divisions.map(d => `<option value="${d}">${d}</option>`).join('') +
        '<option value="Other">Other</option>';

      categorySelect.innerHTML = '<option value="" disabled selected>Select Category</option>' +
        categories.map(c => `<option value="${c}">${c}</option>`).join('') +
        '<option value="Other">Other</option>';
    }

    renderScoreboard();
  </script>
</body>
</html>
